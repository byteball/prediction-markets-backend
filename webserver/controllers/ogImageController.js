const { isValidAddress } = require('ocore/validation_utils');
const sharp = require('sharp');
const fs = require('fs').promises;
const marketDB = require('../../db');
const db = require('ocore/db.js');
const moment = require('moment');
const conf = require('ocore/conf.js');
const { truncate } = require('lodash');

const abbreviations = require('../../abbreviations.json');
const { generateTextEvent } = require('../../utils/generateTextEvent');
const { getEstimateAPY } = require('../../utils/getEstimateAPY');

const knownTypes = ['main', 'faq', 'market', 'create'];

module.exports = async (request, reply) => {
    const { type, address } = (request.params || {});

    if (!type || !knownTypes.includes(type)) {
        return reply.badRequest();
    }

    if (address && !isValidAddress(address)) {
        return reply.badRequest();
    }

    let image;

    try {
        if (type === 'market' && address) {
            const { yes_price = 1, no_price = 1, draw_price = 1, reserve = 0, supply_yes = 0, supply_no = 0, supply_draw = 0, coef = 1 } = await marketDB.api.getActualMarketInfo(address).then(data => data || {}).catch(() => { });

            const rows = await db.query(`SELECT * FROM markets LEFT JOIN market_assets USING (aa_address) WHERE aa_address=?`, [address]);

            if (rows.length !== 1) return reply.notFound();

            const [params] = rows;

            const { event_date, feed_name, oracle, reserve_decimals = 0, reserve_symbol, datafeed_value, comparison, allow_draw = false, result } = params;

            if (!oracle) return reply.notFound();

            let APY = getEstimateAPY({ ...params, coef });

            if (APY > 10e9) {
                APY = '10m+'
            } else if (APY > 1) {
                APY = (+Number(APY).toPrecision(4)).toLocaleString('en-US');
            } else {
                APY = +APY.toFixed(4);
            }

            let yesOddsView = null;
            let drawOddsView = null;
            let noOddsView = null;
            let winnerOddsView = 0;

            if (result && reserve) {
                const winnerSupply = result === 'yes' ? supply_yes : (result === 'no' ? supply_no : supply_draw);

                if (winnerSupply) {
                    winnerOddsView = +Number(reserve / winnerSupply).toPrecision(3);
                }
            }

            if (!result) {
                yesOddsView = supply_yes !== 0 ? 'x' + (+Number((reserve / supply_yes) / yes_price).toPrecision(3)) : '-';
                drawOddsView = (allow_draw && supply_draw !== 0) ? 'x' + (+Number((reserve / supply_draw) / draw_price).toPrecision(3)) : '-';
                noOddsView = supply_no !== 0 ? 'x' + (+Number((reserve / supply_no) / no_price).toPrecision(3)) : '-';
            } else {
                yesOddsView = 'loser';
                noOddsView = 'loser';

                if (allow_draw) {
                    drawOddsView = 'loser';
                }

                if (result === 'yes') {
                    yesOddsView = supply_yes ? `x${winnerOddsView}` : 'winner';
                } else if (result === 'no') {
                    noOddsView = supply_no ? `x${winnerOddsView}` : 'winner';
                } else if (result === 'draw' && allow_draw) {
                    drawOddsView = supply_draw ? `x${winnerOddsView}` : 'winner';
                }
            }

            const eventDateView = moment.unix(event_date).utc().format(conf.sportOracleAddress === oracle ? 'MMM D, h:mm A' : 'lll');

            const reserveView = +Number(reserve / 10 ** reserve_decimals).toPrecision(3);

            if (conf.sportOracleAddress === oracle) {
                const [_, yes_team, no_team] = feed_name.split("_");
                const yes_abbreviation = Object.entries(abbreviations.soccer).find(([index, item]) => item.abbreviation === yes_team);
                const no_abbreviation = Object.entries(abbreviations.soccer).find(([index, item]) => item.abbreviation === no_team);

                const yesTeamName = truncate(yes_abbreviation[1].name, { length: 18 });
                const noTeamName = truncate(no_abbreviation[1].name, { length: 18 });

                const svg = `
            <svg width="1200" height="630" viewBox="0 0 1200 630" style="font-family: 'Inter';" fill="none" xmlns="http://www.w3.org/2000/svg">
            <!-- bg -->
            <rect width="1200" height="630" fill="#141413"/>
            <g transform="translate(0,35)">
                <!-- title -->
                <path d="M213.841 69H203.528V39.9091H213.926C216.852 39.9091 219.371 40.4915 221.483 41.6562C223.595 42.8116 225.219 44.4735 226.355 46.642C227.501 48.8106 228.074 51.4053 228.074 54.4261C228.074 57.4564 227.501 60.0606 226.355 62.2386C225.219 64.4167 223.585 66.0881 221.455 67.2528C219.333 68.4176 216.795 69 213.841 69ZM209.679 63.7301H213.585C215.403 63.7301 216.933 63.4081 218.173 62.7642C219.423 62.1108 220.361 61.1023 220.986 59.7386C221.62 58.3655 221.938 56.5947 221.938 54.4261C221.938 52.2765 221.62 50.5199 220.986 49.1562C220.361 47.7926 219.428 46.7888 218.188 46.1449C216.947 45.5009 215.418 45.179 213.599 45.179H209.679V63.7301ZM232.63 69V39.9091H252.232V44.9801H238.781V51.9119H251.224V56.983H238.781V63.929H252.289V69H232.63ZM282.79 50.0938H276.568C276.455 49.2888 276.223 48.5739 275.872 47.9489C275.522 47.3144 275.072 46.7746 274.523 46.3295C273.973 45.8845 273.339 45.5436 272.619 45.3068C271.909 45.0701 271.137 44.9517 270.304 44.9517C268.798 44.9517 267.487 45.3258 266.369 46.0739C265.252 46.8125 264.385 47.892 263.77 49.3125C263.154 50.7235 262.847 52.4375 262.847 54.4545C262.847 56.5284 263.154 58.2708 263.77 59.6818C264.395 61.0928 265.266 62.1581 266.384 62.8778C267.501 63.5975 268.794 63.9574 270.261 63.9574C271.085 63.9574 271.848 63.8485 272.548 63.6307C273.259 63.4129 273.888 63.0956 274.438 62.679C274.987 62.2528 275.441 61.7367 275.801 61.1307C276.17 60.5246 276.426 59.8333 276.568 59.0568L282.79 59.0852C282.629 60.4205 282.226 61.7083 281.582 62.9489C280.948 64.1799 280.091 65.2831 279.011 66.2585C277.941 67.2244 276.663 67.9915 275.176 68.5597C273.699 69.1184 272.027 69.3977 270.162 69.3977C267.567 69.3977 265.247 68.8106 263.202 67.6364C261.166 66.4621 259.556 64.7623 258.372 62.5369C257.198 60.3116 256.611 57.6174 256.611 54.4545C256.611 51.2822 257.207 48.5833 258.401 46.358C259.594 44.1326 261.213 42.4375 263.259 41.2727C265.304 40.0985 267.605 39.5114 270.162 39.5114C271.848 39.5114 273.41 39.7481 274.849 40.2216C276.298 40.6951 277.581 41.3864 278.699 42.2955C279.816 43.1951 280.725 44.2983 281.426 45.6051C282.136 46.9119 282.591 48.4081 282.79 50.0938ZM287.2 69V39.9091H306.803V44.9801H293.351V51.9119H305.794V56.983H293.351V63.929H306.859V69H287.2ZM336.025 39.9091V69H330.712L318.056 50.6903H317.843V69H311.692V39.9091H317.09L329.647 58.2045H329.903V39.9091H336.025ZM339.999 44.9801V39.9091H363.891V44.9801H354.984V69H348.905V44.9801H339.999ZM367.825 69V39.9091H379.303C381.5 39.9091 383.375 40.3021 384.928 41.0881C386.49 41.8646 387.679 42.9678 388.493 44.3977C389.317 45.8182 389.729 47.4896 389.729 49.4119C389.729 51.3437 389.312 53.0057 388.479 54.3977C387.645 55.7803 386.438 56.8409 384.857 57.5795C383.285 58.3182 381.381 58.6875 379.146 58.6875H371.462V53.7443H378.152C379.326 53.7443 380.302 53.5833 381.078 53.2614C381.855 52.9394 382.432 52.4564 382.811 51.8125C383.199 51.1686 383.393 50.3684 383.393 49.4119C383.393 48.446 383.199 47.6316 382.811 46.9688C382.432 46.3059 381.85 45.804 381.064 45.4631C380.287 45.1127 379.307 44.9375 378.124 44.9375H373.976V69H367.825ZM383.536 55.7614L390.766 69H383.976L376.902 55.7614H383.536ZM399.089 69H392.499L402.541 39.9091H410.467L420.496 69H413.905L406.618 46.5568H406.391L399.089 69ZM398.678 57.5653H414.246V62.3665H398.678V57.5653ZM423.997 69V39.9091H430.148V63.929H442.619V69H423.997ZM452.843 39.9091V69H446.692V39.9091H452.843ZM457.591 69V65.3494L472.108 44.9801H457.562V39.9091H479.835V43.5597L465.304 63.929H479.864V69H457.591ZM484.583 69V39.9091H504.185V44.9801H490.734V51.9119H503.177V56.983H490.734V63.929H504.242V69H484.583ZM519.388 69H509.075V39.9091H519.473C522.399 39.9091 524.918 40.4915 527.03 41.6562C529.142 42.8116 530.766 44.4735 531.902 46.642C533.048 48.8106 533.621 51.4053 533.621 54.4261C533.621 57.4564 533.048 60.0606 531.902 62.2386C530.766 64.4167 529.132 66.0881 527.001 67.2528C524.88 68.4176 522.342 69 519.388 69ZM515.226 63.7301H519.132C520.95 63.7301 522.48 63.4081 523.72 62.7642C524.97 62.1108 525.908 61.1023 526.533 59.7386C527.167 58.3655 527.484 56.5947 527.484 54.4261C527.484 52.2765 527.167 50.5199 526.533 49.1562C525.908 47.7926 524.975 46.7888 523.734 46.1449C522.494 45.5009 520.964 45.179 519.146 45.179H515.226V63.7301Z" fill="white"/>
                <path d="M547.435 69V39.9091H558.912C561.118 39.9091 562.998 40.3305 564.551 41.1733C566.104 42.0066 567.288 43.1667 568.102 44.6534C568.926 46.1307 569.338 47.8352 569.338 49.767C569.338 51.6989 568.921 53.4034 568.088 54.8807C567.255 56.358 566.047 57.5085 564.466 58.3324C562.894 59.1562 560.991 59.5682 558.756 59.5682H551.44V54.6392H557.761C558.945 54.6392 559.92 54.4356 560.688 54.0284C561.464 53.6117 562.042 53.0388 562.42 52.3097C562.809 51.571 563.003 50.7235 563.003 49.767C563.003 48.8011 562.809 47.9583 562.42 47.2386C562.042 46.5095 561.464 45.946 560.688 45.5483C559.911 45.1411 558.926 44.9375 557.733 44.9375H553.585V69H547.435ZM573.333 69V39.9091H584.81C587.007 39.9091 588.882 40.3021 590.435 41.0881C591.998 41.8646 593.186 42.9678 594.001 44.3977C594.825 45.8182 595.237 47.4896 595.237 49.4119C595.237 51.3437 594.82 53.0057 593.987 54.3977C593.153 55.7803 591.946 56.8409 590.364 57.5795C588.792 58.3182 586.889 58.6875 584.654 58.6875H576.969V53.7443H583.66C584.834 53.7443 585.809 53.5833 586.586 53.2614C587.362 52.9394 587.94 52.4564 588.319 51.8125C588.707 51.1686 588.901 50.3684 588.901 49.4119C588.901 48.446 588.707 47.6316 588.319 46.9688C587.94 46.3059 587.358 45.804 586.572 45.4631C585.795 45.1127 584.815 44.9375 583.631 44.9375H579.484V69H573.333ZM589.043 55.7614L596.273 69H589.484L582.41 55.7614H589.043ZM599.583 69V39.9091H619.185V44.9801H605.734V51.9119H618.177V56.983H605.734V63.929H619.242V69H599.583ZM634.388 69H624.075V39.9091H634.473C637.399 39.9091 639.918 40.4915 642.03 41.6562C644.142 42.8116 645.766 44.4735 646.902 46.642C648.048 48.8106 648.621 51.4053 648.621 54.4261C648.621 57.4564 648.048 60.0606 646.902 62.2386C645.766 64.4167 644.132 66.0881 642.001 67.2528C639.88 68.4176 637.342 69 634.388 69ZM630.226 63.7301H634.132C635.95 63.7301 637.48 63.4081 638.72 62.7642C639.97 62.1108 640.908 61.1023 641.533 59.7386C642.167 58.3655 642.484 56.5947 642.484 54.4261C642.484 52.2765 642.167 50.5199 641.533 49.1562C640.908 47.7926 639.975 46.7888 638.734 46.1449C637.494 45.5009 635.964 45.179 634.146 45.179H630.226V63.7301ZM659.327 39.9091V69H653.177V39.9091H659.327ZM690.055 50.0938H683.834C683.72 49.2888 683.488 48.5739 683.138 47.9489C682.787 47.3144 682.338 46.7746 681.788 46.3295C681.239 45.8845 680.605 45.5436 679.885 45.3068C679.175 45.0701 678.403 44.9517 677.57 44.9517C676.064 44.9517 674.752 45.3258 673.635 46.0739C672.518 46.8125 671.651 47.892 671.036 49.3125C670.42 50.7235 670.112 52.4375 670.112 54.4545C670.112 56.5284 670.42 58.2708 671.036 59.6818C671.661 61.0928 672.532 62.1581 673.649 62.8778C674.767 63.5975 676.059 63.9574 677.527 63.9574C678.351 63.9574 679.113 63.8485 679.814 63.6307C680.524 63.4129 681.154 63.0956 681.703 62.679C682.252 62.2528 682.707 61.7367 683.067 61.1307C683.436 60.5246 683.692 59.8333 683.834 59.0568L690.055 59.0852C689.894 60.4205 689.492 61.7083 688.848 62.9489C688.214 64.1799 687.357 65.2831 686.277 66.2585C685.207 67.2244 683.929 67.9915 682.442 68.5597C680.964 69.1184 679.293 69.3977 677.428 69.3977C674.833 69.3977 672.513 68.8106 670.467 67.6364C668.431 66.4621 666.821 64.7623 665.638 62.5369C664.464 60.3116 663.876 57.6174 663.876 54.4545C663.876 51.2822 664.473 48.5833 665.666 46.358C666.859 44.1326 668.479 42.4375 670.524 41.2727C672.57 40.0985 674.871 39.5114 677.428 39.5114C679.113 39.5114 680.676 39.7481 682.115 40.2216C683.564 40.6951 684.847 41.3864 685.964 42.2955C687.082 43.1951 687.991 44.2983 688.692 45.6051C689.402 46.9119 689.857 48.4081 690.055 50.0938ZM693.358 44.9801V39.9091H717.25V44.9801H708.344V69H702.264V44.9801H693.358ZM727.335 39.9091V69H721.185V39.9091H727.335ZM759.129 54.4545C759.129 57.6269 758.527 60.3258 757.325 62.5511C756.131 64.7765 754.503 66.4763 752.438 67.6506C750.383 68.8153 748.073 69.3977 745.506 69.3977C742.921 69.3977 740.601 68.8106 738.546 67.6364C736.491 66.4621 734.867 64.7623 733.674 62.5369C732.481 60.3116 731.884 57.6174 731.884 54.4545C731.884 51.2822 732.481 48.5833 733.674 46.358C734.867 44.1326 736.491 42.4375 738.546 41.2727C740.601 40.0985 742.921 39.5114 745.506 39.5114C748.073 39.5114 750.383 40.0985 752.438 41.2727C754.503 42.4375 756.131 44.1326 757.325 46.358C758.527 48.5833 759.129 51.2822 759.129 54.4545ZM752.893 54.4545C752.893 52.3996 752.585 50.6667 751.969 49.2557C751.363 47.8447 750.506 46.7746 749.398 46.0455C748.29 45.3163 746.993 44.9517 745.506 44.9517C744.02 44.9517 742.722 45.3163 741.614 46.0455C740.506 46.7746 739.645 47.8447 739.029 49.2557C738.423 50.6667 738.12 52.3996 738.12 54.4545C738.12 56.5095 738.423 58.2424 739.029 59.6534C739.645 61.0644 740.506 62.1345 741.614 62.8636C742.722 63.5928 744.02 63.9574 745.506 63.9574C746.993 63.9574 748.29 63.5928 749.398 62.8636C750.506 62.1345 751.363 61.0644 751.969 59.6534C752.585 58.2424 752.893 56.5095 752.893 54.4545ZM788.017 39.9091V69H782.705L770.048 50.6903H769.835V69H763.685V39.9091H769.082L781.639 58.2045H781.895V39.9091H788.017ZM802.357 39.9091H809.942L817.953 59.4545H818.294L826.305 39.9091H833.891V69H827.925V50.0653H827.683L820.155 68.858H816.092L808.564 49.9943H808.322V69H802.357V39.9091ZM843.972 69H837.381L847.424 39.9091H855.35L865.379 69H858.788L851.501 46.5568H851.273L843.972 69ZM843.56 57.5653H859.129V62.3665H843.56V57.5653ZM868.88 69V39.9091H880.357C882.554 39.9091 884.429 40.3021 885.982 41.0881C887.545 41.8646 888.733 42.9678 889.548 44.3977C890.371 45.8182 890.783 47.4896 890.783 49.4119C890.783 51.3437 890.367 53.0057 889.533 54.3977C888.7 55.7803 887.493 56.8409 885.911 57.5795C884.339 58.3182 882.436 58.6875 880.201 58.6875H872.516V53.7443H879.207C880.381 53.7443 881.356 53.5833 882.133 53.2614C882.909 52.9394 883.487 52.4564 883.866 51.8125C884.254 51.1686 884.448 50.3684 884.448 49.4119C884.448 48.446 884.254 47.6316 883.866 46.9688C883.487 46.3059 882.905 45.804 882.119 45.4631C881.342 45.1127 880.362 44.9375 879.178 44.9375H875.031V69H868.88ZM884.59 55.7614L891.82 69H885.031L877.957 55.7614H884.59ZM895.13 69V39.9091H901.281V52.7358H901.664L912.133 39.9091H919.505L908.71 52.9347L919.633 69H912.275L904.306 57.0398L901.281 60.733V69H895.13ZM922.708 69V39.9091H942.31V44.9801H928.859V51.9119H941.302V56.983H928.859V63.929H942.367V69H922.708ZM946.092 44.9801V39.9091H969.984V44.9801H961.078V69H954.999V44.9801H946.092ZM989.7 48.2756C989.587 47.1297 989.099 46.2396 988.237 45.6051C987.375 44.9706 986.206 44.6534 984.729 44.6534C983.725 44.6534 982.877 44.7955 982.186 45.0795C981.495 45.3542 980.964 45.7377 980.595 46.2301C980.235 46.7225 980.055 47.2812 980.055 47.9062C980.036 48.4271 980.145 48.8816 980.382 49.2699C980.628 49.6581 980.964 49.9943 981.391 50.2784C981.817 50.553 982.309 50.7945 982.868 51.0028C983.427 51.2017 984.023 51.3722 984.658 51.5142L987.271 52.1392C988.54 52.4233 989.705 52.8021 990.766 53.2756C991.826 53.7491 992.745 54.3314 993.521 55.0227C994.298 55.714 994.899 56.5284 995.325 57.4659C995.761 58.4034 995.983 59.4782 995.993 60.6903C995.983 62.4706 995.529 64.0142 994.629 65.321C993.739 66.6184 992.451 67.6269 990.766 68.3466C989.089 69.0568 987.068 69.4119 984.7 69.4119C982.352 69.4119 980.306 69.0521 978.564 68.3324C976.831 67.6127 975.477 66.5473 974.501 65.1364C973.536 63.7159 973.029 61.9593 972.982 59.8665H978.933C979 60.8419 979.279 61.6562 979.771 62.3097C980.273 62.9536 980.941 63.4413 981.774 63.7727C982.617 64.0947 983.569 64.2557 984.629 64.2557C985.671 64.2557 986.575 64.1042 987.342 63.8011C988.119 63.4981 988.72 63.0767 989.146 62.5369C989.572 61.9972 989.786 61.3769 989.786 60.6761C989.786 60.0227 989.591 59.4735 989.203 59.0284C988.824 58.5833 988.266 58.2045 987.527 57.892C986.798 57.5795 985.903 57.2955 984.842 57.0398L981.675 56.2443C979.222 55.6477 977.286 54.715 975.865 53.446C974.445 52.1771 973.739 50.4678 973.749 48.3182C973.739 46.5568 974.208 45.018 975.155 43.7017C976.111 42.3854 977.423 41.358 979.089 40.6193C980.756 39.8807 982.65 39.5114 984.771 39.5114C986.93 39.5114 988.815 39.8807 990.425 40.6193C992.044 41.358 993.304 42.3854 994.203 43.7017C995.103 45.018 995.567 46.5426 995.595 48.2756H989.7Z" fill="#2D72F6"/>
            </g>


            <g transform="translate(0,50)">
                <!-- VS -->
                <g transform="translate(0,-8)">
                    <path d="M566.548 140.455L577.798 175.818H578.23L589.503 140.455H600.412L584.366 187H571.685L555.616 140.455H566.548ZM631.264 153.841C631.082 152.008 630.302 150.583 628.923 149.568C627.545 148.553 625.673 148.045 623.31 148.045C621.704 148.045 620.348 148.273 619.241 148.727C618.135 149.167 617.287 149.78 616.696 150.568C616.12 151.356 615.832 152.25 615.832 153.25C615.802 154.083 615.976 154.811 616.355 155.432C616.749 156.053 617.287 156.591 617.969 157.045C618.651 157.485 619.438 157.871 620.332 158.205C621.226 158.523 622.181 158.795 623.196 159.023L627.378 160.023C629.408 160.477 631.272 161.083 632.969 161.841C634.666 162.598 636.135 163.53 637.378 164.636C638.62 165.742 639.582 167.045 640.264 168.545C640.961 170.045 641.317 171.765 641.332 173.705C641.317 176.553 640.59 179.023 639.151 181.114C637.726 183.189 635.666 184.803 632.969 185.955C630.287 187.091 627.052 187.659 623.264 187.659C619.507 187.659 616.234 187.083 613.446 185.932C610.673 184.78 608.507 183.076 606.946 180.818C605.401 178.545 604.59 175.735 604.514 172.386H614.037C614.143 173.947 614.59 175.25 615.378 176.295C616.181 177.326 617.249 178.106 618.582 178.636C619.931 179.152 621.454 179.409 623.151 179.409C624.817 179.409 626.264 179.167 627.491 178.682C628.734 178.197 629.696 177.523 630.378 176.659C631.06 175.795 631.401 174.803 631.401 173.682C631.401 172.636 631.09 171.758 630.469 171.045C629.863 170.333 628.969 169.727 627.787 169.227C626.62 168.727 625.188 168.273 623.491 167.864L618.423 166.591C614.499 165.636 611.401 164.144 609.128 162.114C606.855 160.083 605.726 157.348 605.741 153.909C605.726 151.091 606.476 148.629 607.991 146.523C609.522 144.417 611.62 142.773 614.287 141.591C616.954 140.409 619.984 139.818 623.378 139.818C626.832 139.818 629.848 140.409 632.423 141.591C635.014 142.773 637.029 144.417 638.469 146.523C639.908 148.629 640.651 151.068 640.696 153.841H631.264Z" fill="white"/>
                </g>

                <!-- time -->
                <g transform="translate(475,195)">
                    <text x="125" y="20" text-anchor="middle" alignment-baseline="middle" style="font-size: 26px; fill: #fff;">
                        ${eventDateView}
                    </text>
                </g>

                <g transform="translate(475,225)">
                    <text x="125" y="20" text-anchor="middle" alignment-baseline="middle" style="font-size: 26px; fill: #fff;">
                        UTC
                    </text>
                </g>

                ${(drawOddsView && allow_draw && !result) ? `<g transform="translate(475,290)">
                    <text x="125" y="20" text-anchor="middle" alignment-baseline="middle" style="font-size: 36px; fill: #ffc048;">
                        draw
                    </text>
                </g>

                <g transform="translate(475, 340)">
                    <text x="125" y="20" fill='#ffc048' text-anchor="middle" alignment-baseline="middle" style="font-size: 46px;">${drawOddsView}</text>
                </g>` : null}


                <!-- teams -->
                <g transform="translate(240,290)">
                    <rect width="230" height="40" stroke-width="1"></rect>
                    <text x="115" y="20" fill='#05C46B' text-anchor="middle" alignment-baseline="middle" style="font-size: 36px;">${yesTeamName}</text>
                </g>

                ${(yesOddsView && !result) ? `<g transform="translate(240,340)">
                    <rect width="230" height="40" stroke-width="1"></rect>
                    <text x="115" y="20" fill='#05C46B' text-anchor="middle" alignment-baseline="middle" style="font-size: 46px;">${yesOddsView}</text>
                </g>` : null}

                <g transform="translate(740,290)">
                    <rect width="230" height="40" stroke-width="1"></rect>
                    <text x="115" y="20" fill='#FF5E57' text-anchor="middle" alignment-baseline="middle" style="font-size: 36px;">${noTeamName}</text>
                </g>

                ${(noOddsView && !result) ? `<g transform="translate(740,340)">
                    <rect width="230" height="40" stroke-width="1"></rect>
                    <text x="115" y="20" fill='#FF5E57' text-anchor="middle" alignment-baseline="middle" style="font-size: 46px;">${noOddsView}</text>
                </g>` : null}

            </g>

            <g transform="translate(280, 440)">
                <text x="325" y="50" fill='#fff' text-anchor="middle" alignment-baseline="middle" style="font-size: 46px;">Liquidity provider APY: ${APY}%</text>
            </g>

            <g transform="translate(280, 470)">
                <rect x="280" y="480" width="684" height="108" stroke="#ccc"/>
                <text x="340" y="50" fill='#fff' text-anchor="middle" alignment-baseline="middle" style="font-size: 13px;">
                    <tspan x="340">The APY estimation is for the first LP assuming the trading activity stays the same as it has been so far.</tspan>
                    <tspan x="340" dy="15">Later LPs earn from fewer trades, and the trading activity can change in the future, so the actual APY can be significantly different.</tspan>
                </text>
            </g>

            <!-- url -->
            <g transform="translate(0,-10)">
                <path d="M532.071 598.909V580.909H534.015V582.989H534.253C534.401 582.761 534.605 582.472 534.867 582.119C535.134 581.761 535.515 581.443 536.009 581.165C536.509 580.881 537.185 580.739 538.037 580.739C539.14 580.739 540.111 581.014 540.952 581.565C541.793 582.116 542.449 582.898 542.921 583.909C543.392 584.92 543.628 586.114 543.628 587.489C543.628 588.875 543.392 590.077 542.921 591.094C542.449 592.105 541.796 592.889 540.961 593.446C540.125 593.997 539.162 594.273 538.071 594.273C537.23 594.273 536.557 594.134 536.051 593.855C535.546 593.571 535.157 593.25 534.884 592.892C534.611 592.528 534.401 592.227 534.253 591.989H534.083V598.909H532.071ZM534.049 587.455C534.049 588.443 534.194 589.315 534.483 590.071C534.773 590.821 535.196 591.409 535.753 591.835C536.31 592.256 536.992 592.466 537.799 592.466C538.64 592.466 539.341 592.244 539.904 591.801C540.472 591.352 540.898 590.75 541.182 589.994C541.472 589.233 541.617 588.386 541.617 587.455C541.617 586.534 541.475 585.705 541.191 584.966C540.912 584.222 540.489 583.634 539.921 583.202C539.358 582.764 538.651 582.545 537.799 582.545C536.98 582.545 536.293 582.753 535.736 583.168C535.179 583.577 534.759 584.151 534.475 584.889C534.191 585.622 534.049 586.477 534.049 587.455ZM546.696 594V580.909H548.64V582.886H548.776C549.015 582.239 549.446 581.713 550.071 581.31C550.696 580.906 551.401 580.705 552.185 580.705C552.333 580.705 552.517 580.707 552.739 580.713C552.961 580.719 553.128 580.727 553.242 580.739V582.784C553.174 582.767 553.017 582.741 552.773 582.707C552.534 582.668 552.282 582.648 552.015 582.648C551.378 582.648 550.81 582.781 550.31 583.048C549.816 583.31 549.424 583.673 549.134 584.139C548.85 584.599 548.708 585.125 548.708 585.716V594H546.696ZM560.546 594.273C559.364 594.273 558.327 593.991 557.435 593.429C556.549 592.866 555.855 592.08 555.355 591.068C554.861 590.057 554.614 588.875 554.614 587.523C554.614 586.159 554.861 584.969 555.355 583.952C555.855 582.935 556.549 582.145 557.435 581.582C558.327 581.02 559.364 580.739 560.546 580.739C561.728 580.739 562.762 581.02 563.648 581.582C564.54 582.145 565.233 582.935 565.728 583.952C566.228 584.969 566.478 586.159 566.478 587.523C566.478 588.875 566.228 590.057 565.728 591.068C565.233 592.08 564.54 592.866 563.648 593.429C562.762 593.991 561.728 594.273 560.546 594.273ZM560.546 592.466C561.444 592.466 562.182 592.236 562.762 591.776C563.341 591.315 563.77 590.71 564.049 589.96C564.327 589.21 564.466 588.398 564.466 587.523C564.466 586.648 564.327 585.832 564.049 585.077C563.77 584.321 563.341 583.71 562.762 583.244C562.182 582.778 561.444 582.545 560.546 582.545C559.648 582.545 558.909 582.778 558.33 583.244C557.75 583.71 557.321 584.321 557.043 585.077C556.765 585.832 556.625 586.648 556.625 587.523C556.625 588.398 556.765 589.21 557.043 589.96C557.321 590.71 557.75 591.315 558.33 591.776C558.909 592.236 559.648 592.466 560.546 592.466ZM569.548 598.909V580.909H571.491V582.989H571.73C571.877 582.761 572.082 582.472 572.343 582.119C572.61 581.761 572.991 581.443 573.485 581.165C573.985 580.881 574.662 580.739 575.514 580.739C576.616 580.739 577.588 581.014 578.429 581.565C579.27 582.116 579.926 582.898 580.397 583.909C580.869 584.92 581.105 586.114 581.105 587.489C581.105 588.875 580.869 590.077 580.397 591.094C579.926 592.105 579.272 592.889 578.437 593.446C577.602 593.997 576.639 594.273 575.548 594.273C574.707 594.273 574.034 594.134 573.528 593.855C573.022 593.571 572.633 593.25 572.36 592.892C572.088 592.528 571.877 592.227 571.73 591.989H571.559V598.909H569.548ZM571.525 587.455C571.525 588.443 571.67 589.315 571.96 590.071C572.25 590.821 572.673 591.409 573.23 591.835C573.787 592.256 574.468 592.466 575.275 592.466C576.116 592.466 576.818 592.244 577.38 591.801C577.949 591.352 578.375 590.75 578.659 589.994C578.949 589.233 579.093 588.386 579.093 587.455C579.093 586.534 578.951 585.705 578.667 584.966C578.389 584.222 577.966 583.634 577.397 583.202C576.835 582.764 576.127 582.545 575.275 582.545C574.457 582.545 573.77 582.753 573.213 583.168C572.656 583.577 572.235 584.151 571.951 584.889C571.667 585.622 571.525 586.477 571.525 587.455ZM586.184 586.125V594H584.173V576.545H586.184V582.955H586.355C586.662 582.278 587.122 581.741 587.735 581.344C588.355 580.94 589.179 580.739 590.207 580.739C591.099 580.739 591.88 580.918 592.551 581.276C593.221 581.628 593.741 582.17 594.11 582.903C594.485 583.631 594.673 584.557 594.673 585.682V594H592.662V585.818C592.662 584.778 592.392 583.974 591.852 583.406C591.318 582.832 590.576 582.545 589.627 582.545C588.968 582.545 588.377 582.685 587.855 582.963C587.338 583.241 586.929 583.648 586.627 584.182C586.332 584.716 586.184 585.364 586.184 586.125ZM603.841 594.273C602.58 594.273 601.492 593.994 600.577 593.438C599.668 592.875 598.966 592.091 598.472 591.085C597.983 590.074 597.739 588.898 597.739 587.557C597.739 586.216 597.983 585.034 598.472 584.011C598.966 582.983 599.654 582.182 600.534 581.608C601.421 581.028 602.455 580.739 603.637 580.739C604.319 580.739 604.992 580.852 605.657 581.08C606.321 581.307 606.926 581.676 607.472 582.188C608.017 582.693 608.452 583.364 608.776 584.199C609.1 585.034 609.262 586.062 609.262 587.284V588.136H599.171V586.398H607.216C607.216 585.659 607.069 585 606.773 584.42C606.483 583.841 606.069 583.384 605.529 583.048C604.995 582.713 604.364 582.545 603.637 582.545C602.836 582.545 602.142 582.744 601.557 583.142C600.978 583.534 600.532 584.045 600.219 584.676C599.907 585.307 599.75 585.983 599.75 586.705V587.864C599.75 588.852 599.921 589.69 600.262 590.378C600.608 591.06 601.088 591.58 601.702 591.938C602.316 592.29 603.029 592.466 603.841 592.466C604.37 592.466 604.847 592.392 605.273 592.244C605.705 592.091 606.077 591.864 606.39 591.562C606.702 591.256 606.944 590.875 607.114 590.42L609.057 590.966C608.853 591.625 608.509 592.205 608.026 592.705C607.543 593.199 606.946 593.585 606.236 593.864C605.526 594.136 604.728 594.273 603.841 594.273ZM618.015 580.909V582.614H611.23V580.909H618.015ZM613.208 577.773H615.219V590.25C615.219 590.818 615.301 591.244 615.466 591.528C615.637 591.807 615.853 591.994 616.114 592.091C616.381 592.182 616.662 592.227 616.958 592.227C617.179 592.227 617.361 592.216 617.503 592.193C617.645 592.165 617.759 592.142 617.844 592.125L618.253 593.932C618.117 593.983 617.926 594.034 617.682 594.085C617.438 594.142 617.128 594.17 616.753 594.17C616.185 594.17 615.628 594.048 615.083 593.804C614.543 593.56 614.094 593.188 613.736 592.688C613.384 592.188 613.208 591.557 613.208 590.795V577.773ZM622.506 594.136C622.086 594.136 621.725 593.986 621.424 593.685C621.123 593.384 620.972 593.023 620.972 592.602C620.972 592.182 621.123 591.821 621.424 591.52C621.725 591.219 622.086 591.068 622.506 591.068C622.926 591.068 623.287 591.219 623.588 591.52C623.89 591.821 624.04 592.182 624.04 592.602C624.04 592.881 623.969 593.136 623.827 593.369C623.691 593.602 623.506 593.79 623.273 593.932C623.046 594.068 622.79 594.136 622.506 594.136ZM632.968 594.273C631.786 594.273 630.749 593.991 629.857 593.429C628.971 592.866 628.277 592.08 627.777 591.068C627.283 590.057 627.036 588.875 627.036 587.523C627.036 586.159 627.283 584.969 627.777 583.952C628.277 582.935 628.971 582.145 629.857 581.582C630.749 581.02 631.786 580.739 632.968 580.739C634.15 580.739 635.184 581.02 636.07 581.582C636.962 582.145 637.655 582.935 638.15 583.952C638.65 584.969 638.9 586.159 638.9 587.523C638.9 588.875 638.65 590.057 638.15 591.068C637.655 592.08 636.962 592.866 636.07 593.429C635.184 593.991 634.15 594.273 632.968 594.273ZM632.968 592.466C633.865 592.466 634.604 592.236 635.184 591.776C635.763 591.315 636.192 590.71 636.471 589.96C636.749 589.21 636.888 588.398 636.888 587.523C636.888 586.648 636.749 585.832 636.471 585.077C636.192 584.321 635.763 583.71 635.184 583.244C634.604 582.778 633.865 582.545 632.968 582.545C632.07 582.545 631.331 582.778 630.752 583.244C630.172 583.71 629.743 584.321 629.465 585.077C629.186 585.832 629.047 586.648 629.047 587.523C629.047 588.398 629.186 589.21 629.465 589.96C629.743 590.71 630.172 591.315 630.752 591.776C631.331 592.236 632.07 592.466 632.968 592.466ZM647.288 594.273C646.106 594.273 645.069 593.991 644.177 593.429C643.291 592.866 642.598 592.08 642.098 591.068C641.603 590.057 641.356 588.875 641.356 587.523C641.356 586.159 641.603 584.969 642.098 583.952C642.598 582.935 643.291 582.145 644.177 581.582C645.069 581.02 646.106 580.739 647.288 580.739C648.47 580.739 649.504 581.02 650.39 581.582C651.282 582.145 651.975 582.935 652.47 583.952C652.97 584.969 653.22 586.159 653.22 587.523C653.22 588.875 652.97 590.057 652.47 591.068C651.975 592.08 651.282 592.866 650.39 593.429C649.504 593.991 648.47 594.273 647.288 594.273ZM647.288 592.466C648.186 592.466 648.924 592.236 649.504 591.776C650.083 591.315 650.512 590.71 650.791 589.96C651.069 589.21 651.208 588.398 651.208 587.523C651.208 586.648 651.069 585.832 650.791 585.077C650.512 584.321 650.083 583.71 649.504 583.244C648.924 582.778 648.186 582.545 647.288 582.545C646.39 582.545 645.652 582.778 645.072 583.244C644.493 583.71 644.064 584.321 643.785 585.077C643.507 585.832 643.368 586.648 643.368 587.523C643.368 588.398 643.507 589.21 643.785 589.96C644.064 590.71 644.493 591.315 645.072 591.776C645.652 592.236 646.39 592.466 647.288 592.466ZM661.608 594.273C660.426 594.273 659.39 593.991 658.498 593.429C657.611 592.866 656.918 592.08 656.418 591.068C655.924 590.057 655.676 588.875 655.676 587.523C655.676 586.159 655.924 584.969 656.418 583.952C656.918 582.935 657.611 582.145 658.498 581.582C659.39 581.02 660.426 580.739 661.608 580.739C662.79 580.739 663.824 581.02 664.711 581.582C665.603 582.145 666.296 582.935 666.79 583.952C667.29 584.969 667.54 586.159 667.54 587.523C667.54 588.875 667.29 590.057 666.79 591.068C666.296 592.08 665.603 592.866 664.711 593.429C663.824 593.991 662.79 594.273 661.608 594.273ZM661.608 592.466C662.506 592.466 663.245 592.236 663.824 591.776C664.404 591.315 664.833 590.71 665.111 589.96C665.39 589.21 665.529 588.398 665.529 587.523C665.529 586.648 665.39 585.832 665.111 585.077C664.833 584.321 664.404 583.71 663.824 583.244C663.245 582.778 662.506 582.545 661.608 582.545C660.711 582.545 659.972 582.778 659.392 583.244C658.813 583.71 658.384 584.321 658.105 585.077C657.827 585.832 657.688 586.648 657.688 587.523C657.688 588.398 657.827 589.21 658.105 589.96C658.384 590.71 658.813 591.315 659.392 591.776C659.972 592.236 660.711 592.466 661.608 592.466Z" fill="white"/>
            </g>

            </svg>
        `;

                const [yesEmblemBuffer, noEmblemBuffer] = await Promise.all([
                    fs.readFile(`emblems/${yes_abbreviation[0]}.svg`).catch(() => {
                        return fs.readFile(`emblems/${yes_abbreviation[0]}.png`)
                    }),

                    fs.readFile(`emblems/${no_abbreviation[0]}.svg`).catch(() => {
                        return fs.readFile(`emblems/${no_abbreviation[0]}.png`)
                    })
                ]);

                const yesEmblemBufferResized = await sharp(yesEmblemBuffer)
                    .resize(150, 150, { fit: 'contain', background: '#141412' })
                    .toBuffer();

                const noEmblemBufferResized = await sharp(noEmblemBuffer)
                    .resize(150, 150, { fit: 'contain', background: '#141412' })
                    .toBuffer();

                const b = await Buffer.from(svg);

                try {
                    image = await sharp(b)
                        .composite([
                            { input: yesEmblemBufferResized, left: 280, top: 155 },
                            { input: noEmblemBufferResized, left: 780, top: 155, }
                        ])
                        .jpeg().toBuffer();
                } catch (e) {
                    console.error(e)
                }
            } else {
                const event = generateTextEvent({ oracle, event_date, feed_name, datafeed_value, comparison, isUTC: true })

                const [firstString, secondString] = strToArrayLines(event, 45);

                const svg = `
            <svg width="1200" height="630" viewBox="0 0 1200 630" style="font-family: 'Inter';" fill="none" xmlns="http://www.w3.org/2000/svg">
            <!-- bg -->
            <rect width="1200" height="630" fill="#141413"/>
            
            <g transform="translate(0,35)">
                <!-- title -->
                <path d="M213.841 69H203.528V39.9091H213.926C216.852 39.9091 219.371 40.4915 221.483 41.6562C223.595 42.8116 225.219 44.4735 226.355 46.642C227.501 48.8106 228.074 51.4053 228.074 54.4261C228.074 57.4564 227.501 60.0606 226.355 62.2386C225.219 64.4167 223.585 66.0881 221.455 67.2528C219.333 68.4176 216.795 69 213.841 69ZM209.679 63.7301H213.585C215.403 63.7301 216.933 63.4081 218.173 62.7642C219.423 62.1108 220.361 61.1023 220.986 59.7386C221.62 58.3655 221.938 56.5947 221.938 54.4261C221.938 52.2765 221.62 50.5199 220.986 49.1562C220.361 47.7926 219.428 46.7888 218.188 46.1449C216.947 45.5009 215.418 45.179 213.599 45.179H209.679V63.7301ZM232.63 69V39.9091H252.232V44.9801H238.781V51.9119H251.224V56.983H238.781V63.929H252.289V69H232.63ZM282.79 50.0938H276.568C276.455 49.2888 276.223 48.5739 275.872 47.9489C275.522 47.3144 275.072 46.7746 274.523 46.3295C273.973 45.8845 273.339 45.5436 272.619 45.3068C271.909 45.0701 271.137 44.9517 270.304 44.9517C268.798 44.9517 267.487 45.3258 266.369 46.0739C265.252 46.8125 264.385 47.892 263.77 49.3125C263.154 50.7235 262.847 52.4375 262.847 54.4545C262.847 56.5284 263.154 58.2708 263.77 59.6818C264.395 61.0928 265.266 62.1581 266.384 62.8778C267.501 63.5975 268.794 63.9574 270.261 63.9574C271.085 63.9574 271.848 63.8485 272.548 63.6307C273.259 63.4129 273.888 63.0956 274.438 62.679C274.987 62.2528 275.441 61.7367 275.801 61.1307C276.17 60.5246 276.426 59.8333 276.568 59.0568L282.79 59.0852C282.629 60.4205 282.226 61.7083 281.582 62.9489C280.948 64.1799 280.091 65.2831 279.011 66.2585C277.941 67.2244 276.663 67.9915 275.176 68.5597C273.699 69.1184 272.027 69.3977 270.162 69.3977C267.567 69.3977 265.247 68.8106 263.202 67.6364C261.166 66.4621 259.556 64.7623 258.372 62.5369C257.198 60.3116 256.611 57.6174 256.611 54.4545C256.611 51.2822 257.207 48.5833 258.401 46.358C259.594 44.1326 261.213 42.4375 263.259 41.2727C265.304 40.0985 267.605 39.5114 270.162 39.5114C271.848 39.5114 273.41 39.7481 274.849 40.2216C276.298 40.6951 277.581 41.3864 278.699 42.2955C279.816 43.1951 280.725 44.2983 281.426 45.6051C282.136 46.9119 282.591 48.4081 282.79 50.0938ZM287.2 69V39.9091H306.803V44.9801H293.351V51.9119H305.794V56.983H293.351V63.929H306.859V69H287.2ZM336.025 39.9091V69H330.712L318.056 50.6903H317.843V69H311.692V39.9091H317.09L329.647 58.2045H329.903V39.9091H336.025ZM339.999 44.9801V39.9091H363.891V44.9801H354.984V69H348.905V44.9801H339.999ZM367.825 69V39.9091H379.303C381.5 39.9091 383.375 40.3021 384.928 41.0881C386.49 41.8646 387.679 42.9678 388.493 44.3977C389.317 45.8182 389.729 47.4896 389.729 49.4119C389.729 51.3437 389.312 53.0057 388.479 54.3977C387.645 55.7803 386.438 56.8409 384.857 57.5795C383.285 58.3182 381.381 58.6875 379.146 58.6875H371.462V53.7443H378.152C379.326 53.7443 380.302 53.5833 381.078 53.2614C381.855 52.9394 382.432 52.4564 382.811 51.8125C383.199 51.1686 383.393 50.3684 383.393 49.4119C383.393 48.446 383.199 47.6316 382.811 46.9688C382.432 46.3059 381.85 45.804 381.064 45.4631C380.287 45.1127 379.307 44.9375 378.124 44.9375H373.976V69H367.825ZM383.536 55.7614L390.766 69H383.976L376.902 55.7614H383.536ZM399.089 69H392.499L402.541 39.9091H410.467L420.496 69H413.905L406.618 46.5568H406.391L399.089 69ZM398.678 57.5653H414.246V62.3665H398.678V57.5653ZM423.997 69V39.9091H430.148V63.929H442.619V69H423.997ZM452.843 39.9091V69H446.692V39.9091H452.843ZM457.591 69V65.3494L472.108 44.9801H457.562V39.9091H479.835V43.5597L465.304 63.929H479.864V69H457.591ZM484.583 69V39.9091H504.185V44.9801H490.734V51.9119H503.177V56.983H490.734V63.929H504.242V69H484.583ZM519.388 69H509.075V39.9091H519.473C522.399 39.9091 524.918 40.4915 527.03 41.6562C529.142 42.8116 530.766 44.4735 531.902 46.642C533.048 48.8106 533.621 51.4053 533.621 54.4261C533.621 57.4564 533.048 60.0606 531.902 62.2386C530.766 64.4167 529.132 66.0881 527.001 67.2528C524.88 68.4176 522.342 69 519.388 69ZM515.226 63.7301H519.132C520.95 63.7301 522.48 63.4081 523.72 62.7642C524.97 62.1108 525.908 61.1023 526.533 59.7386C527.167 58.3655 527.484 56.5947 527.484 54.4261C527.484 52.2765 527.167 50.5199 526.533 49.1562C525.908 47.7926 524.975 46.7888 523.734 46.1449C522.494 45.5009 520.964 45.179 519.146 45.179H515.226V63.7301Z" fill="white"/>
                <path d="M547.435 69V39.9091H558.912C561.118 39.9091 562.998 40.3305 564.551 41.1733C566.104 42.0066 567.288 43.1667 568.102 44.6534C568.926 46.1307 569.338 47.8352 569.338 49.767C569.338 51.6989 568.921 53.4034 568.088 54.8807C567.255 56.358 566.047 57.5085 564.466 58.3324C562.894 59.1562 560.991 59.5682 558.756 59.5682H551.44V54.6392H557.761C558.945 54.6392 559.92 54.4356 560.688 54.0284C561.464 53.6117 562.042 53.0388 562.42 52.3097C562.809 51.571 563.003 50.7235 563.003 49.767C563.003 48.8011 562.809 47.9583 562.42 47.2386C562.042 46.5095 561.464 45.946 560.688 45.5483C559.911 45.1411 558.926 44.9375 557.733 44.9375H553.585V69H547.435ZM573.333 69V39.9091H584.81C587.007 39.9091 588.882 40.3021 590.435 41.0881C591.998 41.8646 593.186 42.9678 594.001 44.3977C594.825 45.8182 595.237 47.4896 595.237 49.4119C595.237 51.3437 594.82 53.0057 593.987 54.3977C593.153 55.7803 591.946 56.8409 590.364 57.5795C588.792 58.3182 586.889 58.6875 584.654 58.6875H576.969V53.7443H583.66C584.834 53.7443 585.809 53.5833 586.586 53.2614C587.362 52.9394 587.94 52.4564 588.319 51.8125C588.707 51.1686 588.901 50.3684 588.901 49.4119C588.901 48.446 588.707 47.6316 588.319 46.9688C587.94 46.3059 587.358 45.804 586.572 45.4631C585.795 45.1127 584.815 44.9375 583.631 44.9375H579.484V69H573.333ZM589.043 55.7614L596.273 69H589.484L582.41 55.7614H589.043ZM599.583 69V39.9091H619.185V44.9801H605.734V51.9119H618.177V56.983H605.734V63.929H619.242V69H599.583ZM634.388 69H624.075V39.9091H634.473C637.399 39.9091 639.918 40.4915 642.03 41.6562C644.142 42.8116 645.766 44.4735 646.902 46.642C648.048 48.8106 648.621 51.4053 648.621 54.4261C648.621 57.4564 648.048 60.0606 646.902 62.2386C645.766 64.4167 644.132 66.0881 642.001 67.2528C639.88 68.4176 637.342 69 634.388 69ZM630.226 63.7301H634.132C635.95 63.7301 637.48 63.4081 638.72 62.7642C639.97 62.1108 640.908 61.1023 641.533 59.7386C642.167 58.3655 642.484 56.5947 642.484 54.4261C642.484 52.2765 642.167 50.5199 641.533 49.1562C640.908 47.7926 639.975 46.7888 638.734 46.1449C637.494 45.5009 635.964 45.179 634.146 45.179H630.226V63.7301ZM659.327 39.9091V69H653.177V39.9091H659.327ZM690.055 50.0938H683.834C683.72 49.2888 683.488 48.5739 683.138 47.9489C682.787 47.3144 682.338 46.7746 681.788 46.3295C681.239 45.8845 680.605 45.5436 679.885 45.3068C679.175 45.0701 678.403 44.9517 677.57 44.9517C676.064 44.9517 674.752 45.3258 673.635 46.0739C672.518 46.8125 671.651 47.892 671.036 49.3125C670.42 50.7235 670.112 52.4375 670.112 54.4545C670.112 56.5284 670.42 58.2708 671.036 59.6818C671.661 61.0928 672.532 62.1581 673.649 62.8778C674.767 63.5975 676.059 63.9574 677.527 63.9574C678.351 63.9574 679.113 63.8485 679.814 63.6307C680.524 63.4129 681.154 63.0956 681.703 62.679C682.252 62.2528 682.707 61.7367 683.067 61.1307C683.436 60.5246 683.692 59.8333 683.834 59.0568L690.055 59.0852C689.894 60.4205 689.492 61.7083 688.848 62.9489C688.214 64.1799 687.357 65.2831 686.277 66.2585C685.207 67.2244 683.929 67.9915 682.442 68.5597C680.964 69.1184 679.293 69.3977 677.428 69.3977C674.833 69.3977 672.513 68.8106 670.467 67.6364C668.431 66.4621 666.821 64.7623 665.638 62.5369C664.464 60.3116 663.876 57.6174 663.876 54.4545C663.876 51.2822 664.473 48.5833 665.666 46.358C666.859 44.1326 668.479 42.4375 670.524 41.2727C672.57 40.0985 674.871 39.5114 677.428 39.5114C679.113 39.5114 680.676 39.7481 682.115 40.2216C683.564 40.6951 684.847 41.3864 685.964 42.2955C687.082 43.1951 687.991 44.2983 688.692 45.6051C689.402 46.9119 689.857 48.4081 690.055 50.0938ZM693.358 44.9801V39.9091H717.25V44.9801H708.344V69H702.264V44.9801H693.358ZM727.335 39.9091V69H721.185V39.9091H727.335ZM759.129 54.4545C759.129 57.6269 758.527 60.3258 757.325 62.5511C756.131 64.7765 754.503 66.4763 752.438 67.6506C750.383 68.8153 748.073 69.3977 745.506 69.3977C742.921 69.3977 740.601 68.8106 738.546 67.6364C736.491 66.4621 734.867 64.7623 733.674 62.5369C732.481 60.3116 731.884 57.6174 731.884 54.4545C731.884 51.2822 732.481 48.5833 733.674 46.358C734.867 44.1326 736.491 42.4375 738.546 41.2727C740.601 40.0985 742.921 39.5114 745.506 39.5114C748.073 39.5114 750.383 40.0985 752.438 41.2727C754.503 42.4375 756.131 44.1326 757.325 46.358C758.527 48.5833 759.129 51.2822 759.129 54.4545ZM752.893 54.4545C752.893 52.3996 752.585 50.6667 751.969 49.2557C751.363 47.8447 750.506 46.7746 749.398 46.0455C748.29 45.3163 746.993 44.9517 745.506 44.9517C744.02 44.9517 742.722 45.3163 741.614 46.0455C740.506 46.7746 739.645 47.8447 739.029 49.2557C738.423 50.6667 738.12 52.3996 738.12 54.4545C738.12 56.5095 738.423 58.2424 739.029 59.6534C739.645 61.0644 740.506 62.1345 741.614 62.8636C742.722 63.5928 744.02 63.9574 745.506 63.9574C746.993 63.9574 748.29 63.5928 749.398 62.8636C750.506 62.1345 751.363 61.0644 751.969 59.6534C752.585 58.2424 752.893 56.5095 752.893 54.4545ZM788.017 39.9091V69H782.705L770.048 50.6903H769.835V69H763.685V39.9091H769.082L781.639 58.2045H781.895V39.9091H788.017ZM802.357 39.9091H809.942L817.953 59.4545H818.294L826.305 39.9091H833.891V69H827.925V50.0653H827.683L820.155 68.858H816.092L808.564 49.9943H808.322V69H802.357V39.9091ZM843.972 69H837.381L847.424 39.9091H855.35L865.379 69H858.788L851.501 46.5568H851.273L843.972 69ZM843.56 57.5653H859.129V62.3665H843.56V57.5653ZM868.88 69V39.9091H880.357C882.554 39.9091 884.429 40.3021 885.982 41.0881C887.545 41.8646 888.733 42.9678 889.548 44.3977C890.371 45.8182 890.783 47.4896 890.783 49.4119C890.783 51.3437 890.367 53.0057 889.533 54.3977C888.7 55.7803 887.493 56.8409 885.911 57.5795C884.339 58.3182 882.436 58.6875 880.201 58.6875H872.516V53.7443H879.207C880.381 53.7443 881.356 53.5833 882.133 53.2614C882.909 52.9394 883.487 52.4564 883.866 51.8125C884.254 51.1686 884.448 50.3684 884.448 49.4119C884.448 48.446 884.254 47.6316 883.866 46.9688C883.487 46.3059 882.905 45.804 882.119 45.4631C881.342 45.1127 880.362 44.9375 879.178 44.9375H875.031V69H868.88ZM884.59 55.7614L891.82 69H885.031L877.957 55.7614H884.59ZM895.13 69V39.9091H901.281V52.7358H901.664L912.133 39.9091H919.505L908.71 52.9347L919.633 69H912.275L904.306 57.0398L901.281 60.733V69H895.13ZM922.708 69V39.9091H942.31V44.9801H928.859V51.9119H941.302V56.983H928.859V63.929H942.367V69H922.708ZM946.092 44.9801V39.9091H969.984V44.9801H961.078V69H954.999V44.9801H946.092ZM989.7 48.2756C989.587 47.1297 989.099 46.2396 988.237 45.6051C987.375 44.9706 986.206 44.6534 984.729 44.6534C983.725 44.6534 982.877 44.7955 982.186 45.0795C981.495 45.3542 980.964 45.7377 980.595 46.2301C980.235 46.7225 980.055 47.2812 980.055 47.9062C980.036 48.4271 980.145 48.8816 980.382 49.2699C980.628 49.6581 980.964 49.9943 981.391 50.2784C981.817 50.553 982.309 50.7945 982.868 51.0028C983.427 51.2017 984.023 51.3722 984.658 51.5142L987.271 52.1392C988.54 52.4233 989.705 52.8021 990.766 53.2756C991.826 53.7491 992.745 54.3314 993.521 55.0227C994.298 55.714 994.899 56.5284 995.325 57.4659C995.761 58.4034 995.983 59.4782 995.993 60.6903C995.983 62.4706 995.529 64.0142 994.629 65.321C993.739 66.6184 992.451 67.6269 990.766 68.3466C989.089 69.0568 987.068 69.4119 984.7 69.4119C982.352 69.4119 980.306 69.0521 978.564 68.3324C976.831 67.6127 975.477 66.5473 974.501 65.1364C973.536 63.7159 973.029 61.9593 972.982 59.8665H978.933C979 60.8419 979.279 61.6562 979.771 62.3097C980.273 62.9536 980.941 63.4413 981.774 63.7727C982.617 64.0947 983.569 64.2557 984.629 64.2557C985.671 64.2557 986.575 64.1042 987.342 63.8011C988.119 63.4981 988.72 63.0767 989.146 62.5369C989.572 61.9972 989.786 61.3769 989.786 60.6761C989.786 60.0227 989.591 59.4735 989.203 59.0284C988.824 58.5833 988.266 58.2045 987.527 57.892C986.798 57.5795 985.903 57.2955 984.842 57.0398L981.675 56.2443C979.222 55.6477 977.286 54.715 975.865 53.446C974.445 52.1771 973.739 50.4678 973.749 48.3182C973.739 46.5568 974.208 45.018 975.155 43.7017C976.111 42.3854 977.423 41.358 979.089 40.6193C980.756 39.8807 982.65 39.5114 984.771 39.5114C986.93 39.5114 988.815 39.8807 990.425 40.6193C992.044 41.358 993.304 42.3854 994.203 43.7017C995.103 45.018 995.567 46.5426 995.595 48.2756H989.7Z" fill="#2D72F6"/>
             </g>
             
            <g transform="translate(150, 125)">
                <text x="450" y="50" fill='#fff' text-anchor="middle" alignment-baseline="middle" style="font-size: 46px;">
                    <tspan x="450">${firstString}</tspan>
                    ${secondString.length && `<tspan x="450" dy="55">${secondString}</tspan>`}
                </text>
            </g>
            

            <g transform="translate(0, 20)">
                <rect x="220" y="250" width="760" height="156" rx="20" fill="#303030"/>

                <!-- reserve label -->
                <text x="250" y="310" style="font-size: 30px; fill: #fff;">RESERVE</text>
                <!-- reserve value -->
                <text x="250" y="370" style="font-size: 38px; fill: #fff;">${reserveView} ${reserve_symbol === 'GBYTE' ? 'GB' : reserve_symbol}</text>
                
                <!-- yes label -->
                <text x="${allow_draw ? 490 : 483}" y="310" style="font-size: 30px; fill: #05c46b;">YES</text>
                
                <!-- yes value -->
                <text x="${allow_draw ? 490 : 483}" y="370" style="font-size: 38px; fill: #05c46b;">${yesOddsView}</text>

                ${allow_draw && `
                    <!-- draw label -->
                    <text x="643" y="310" style="font-size: 30px; fill: #ffc048;">DRAW</text>
                    
                    <!-- draw value -->
                    <text x="643" y="370" style="font-size: 38px; fill: #ffc048;">${drawOddsView}</text>
                `}

                <!-- no label -->
                <text x="${allow_draw ? 796 : 723}" y="310" style="font-size: 30px; fill: #ff5e57;">NO</text>
                
                <!-- no value -->
                <text x="${allow_draw ? 796 : 723}" y="370" style="font-size: 38px; fill: #ff5e57;">${noOddsView}</text>

            </g>
            <!-- url -->
            <g transform="translate(0,-10)">
                <path d="M532.071 598.909V580.909H534.015V582.989H534.253C534.401 582.761 534.605 582.472 534.867 582.119C535.134 581.761 535.515 581.443 536.009 581.165C536.509 580.881 537.185 580.739 538.037 580.739C539.14 580.739 540.111 581.014 540.952 581.565C541.793 582.116 542.449 582.898 542.921 583.909C543.392 584.92 543.628 586.114 543.628 587.489C543.628 588.875 543.392 590.077 542.921 591.094C542.449 592.105 541.796 592.889 540.961 593.446C540.125 593.997 539.162 594.273 538.071 594.273C537.23 594.273 536.557 594.134 536.051 593.855C535.546 593.571 535.157 593.25 534.884 592.892C534.611 592.528 534.401 592.227 534.253 591.989H534.083V598.909H532.071ZM534.049 587.455C534.049 588.443 534.194 589.315 534.483 590.071C534.773 590.821 535.196 591.409 535.753 591.835C536.31 592.256 536.992 592.466 537.799 592.466C538.64 592.466 539.341 592.244 539.904 591.801C540.472 591.352 540.898 590.75 541.182 589.994C541.472 589.233 541.617 588.386 541.617 587.455C541.617 586.534 541.475 585.705 541.191 584.966C540.912 584.222 540.489 583.634 539.921 583.202C539.358 582.764 538.651 582.545 537.799 582.545C536.98 582.545 536.293 582.753 535.736 583.168C535.179 583.577 534.759 584.151 534.475 584.889C534.191 585.622 534.049 586.477 534.049 587.455ZM546.696 594V580.909H548.64V582.886H548.776C549.015 582.239 549.446 581.713 550.071 581.31C550.696 580.906 551.401 580.705 552.185 580.705C552.333 580.705 552.517 580.707 552.739 580.713C552.961 580.719 553.128 580.727 553.242 580.739V582.784C553.174 582.767 553.017 582.741 552.773 582.707C552.534 582.668 552.282 582.648 552.015 582.648C551.378 582.648 550.81 582.781 550.31 583.048C549.816 583.31 549.424 583.673 549.134 584.139C548.85 584.599 548.708 585.125 548.708 585.716V594H546.696ZM560.546 594.273C559.364 594.273 558.327 593.991 557.435 593.429C556.549 592.866 555.855 592.08 555.355 591.068C554.861 590.057 554.614 588.875 554.614 587.523C554.614 586.159 554.861 584.969 555.355 583.952C555.855 582.935 556.549 582.145 557.435 581.582C558.327 581.02 559.364 580.739 560.546 580.739C561.728 580.739 562.762 581.02 563.648 581.582C564.54 582.145 565.233 582.935 565.728 583.952C566.228 584.969 566.478 586.159 566.478 587.523C566.478 588.875 566.228 590.057 565.728 591.068C565.233 592.08 564.54 592.866 563.648 593.429C562.762 593.991 561.728 594.273 560.546 594.273ZM560.546 592.466C561.444 592.466 562.182 592.236 562.762 591.776C563.341 591.315 563.77 590.71 564.049 589.96C564.327 589.21 564.466 588.398 564.466 587.523C564.466 586.648 564.327 585.832 564.049 585.077C563.77 584.321 563.341 583.71 562.762 583.244C562.182 582.778 561.444 582.545 560.546 582.545C559.648 582.545 558.909 582.778 558.33 583.244C557.75 583.71 557.321 584.321 557.043 585.077C556.765 585.832 556.625 586.648 556.625 587.523C556.625 588.398 556.765 589.21 557.043 589.96C557.321 590.71 557.75 591.315 558.33 591.776C558.909 592.236 559.648 592.466 560.546 592.466ZM569.548 598.909V580.909H571.491V582.989H571.73C571.877 582.761 572.082 582.472 572.343 582.119C572.61 581.761 572.991 581.443 573.485 581.165C573.985 580.881 574.662 580.739 575.514 580.739C576.616 580.739 577.588 581.014 578.429 581.565C579.27 582.116 579.926 582.898 580.397 583.909C580.869 584.92 581.105 586.114 581.105 587.489C581.105 588.875 580.869 590.077 580.397 591.094C579.926 592.105 579.272 592.889 578.437 593.446C577.602 593.997 576.639 594.273 575.548 594.273C574.707 594.273 574.034 594.134 573.528 593.855C573.022 593.571 572.633 593.25 572.36 592.892C572.088 592.528 571.877 592.227 571.73 591.989H571.559V598.909H569.548ZM571.525 587.455C571.525 588.443 571.67 589.315 571.96 590.071C572.25 590.821 572.673 591.409 573.23 591.835C573.787 592.256 574.468 592.466 575.275 592.466C576.116 592.466 576.818 592.244 577.38 591.801C577.949 591.352 578.375 590.75 578.659 589.994C578.949 589.233 579.093 588.386 579.093 587.455C579.093 586.534 578.951 585.705 578.667 584.966C578.389 584.222 577.966 583.634 577.397 583.202C576.835 582.764 576.127 582.545 575.275 582.545C574.457 582.545 573.77 582.753 573.213 583.168C572.656 583.577 572.235 584.151 571.951 584.889C571.667 585.622 571.525 586.477 571.525 587.455ZM586.184 586.125V594H584.173V576.545H586.184V582.955H586.355C586.662 582.278 587.122 581.741 587.735 581.344C588.355 580.94 589.179 580.739 590.207 580.739C591.099 580.739 591.88 580.918 592.551 581.276C593.221 581.628 593.741 582.17 594.11 582.903C594.485 583.631 594.673 584.557 594.673 585.682V594H592.662V585.818C592.662 584.778 592.392 583.974 591.852 583.406C591.318 582.832 590.576 582.545 589.627 582.545C588.968 582.545 588.377 582.685 587.855 582.963C587.338 583.241 586.929 583.648 586.627 584.182C586.332 584.716 586.184 585.364 586.184 586.125ZM603.841 594.273C602.58 594.273 601.492 593.994 600.577 593.438C599.668 592.875 598.966 592.091 598.472 591.085C597.983 590.074 597.739 588.898 597.739 587.557C597.739 586.216 597.983 585.034 598.472 584.011C598.966 582.983 599.654 582.182 600.534 581.608C601.421 581.028 602.455 580.739 603.637 580.739C604.319 580.739 604.992 580.852 605.657 581.08C606.321 581.307 606.926 581.676 607.472 582.188C608.017 582.693 608.452 583.364 608.776 584.199C609.1 585.034 609.262 586.062 609.262 587.284V588.136H599.171V586.398H607.216C607.216 585.659 607.069 585 606.773 584.42C606.483 583.841 606.069 583.384 605.529 583.048C604.995 582.713 604.364 582.545 603.637 582.545C602.836 582.545 602.142 582.744 601.557 583.142C600.978 583.534 600.532 584.045 600.219 584.676C599.907 585.307 599.75 585.983 599.75 586.705V587.864C599.75 588.852 599.921 589.69 600.262 590.378C600.608 591.06 601.088 591.58 601.702 591.938C602.316 592.29 603.029 592.466 603.841 592.466C604.37 592.466 604.847 592.392 605.273 592.244C605.705 592.091 606.077 591.864 606.39 591.562C606.702 591.256 606.944 590.875 607.114 590.42L609.057 590.966C608.853 591.625 608.509 592.205 608.026 592.705C607.543 593.199 606.946 593.585 606.236 593.864C605.526 594.136 604.728 594.273 603.841 594.273ZM618.015 580.909V582.614H611.23V580.909H618.015ZM613.208 577.773H615.219V590.25C615.219 590.818 615.301 591.244 615.466 591.528C615.637 591.807 615.853 591.994 616.114 592.091C616.381 592.182 616.662 592.227 616.958 592.227C617.179 592.227 617.361 592.216 617.503 592.193C617.645 592.165 617.759 592.142 617.844 592.125L618.253 593.932C618.117 593.983 617.926 594.034 617.682 594.085C617.438 594.142 617.128 594.17 616.753 594.17C616.185 594.17 615.628 594.048 615.083 593.804C614.543 593.56 614.094 593.188 613.736 592.688C613.384 592.188 613.208 591.557 613.208 590.795V577.773ZM622.506 594.136C622.086 594.136 621.725 593.986 621.424 593.685C621.123 593.384 620.972 593.023 620.972 592.602C620.972 592.182 621.123 591.821 621.424 591.52C621.725 591.219 622.086 591.068 622.506 591.068C622.926 591.068 623.287 591.219 623.588 591.52C623.89 591.821 624.04 592.182 624.04 592.602C624.04 592.881 623.969 593.136 623.827 593.369C623.691 593.602 623.506 593.79 623.273 593.932C623.046 594.068 622.79 594.136 622.506 594.136ZM632.968 594.273C631.786 594.273 630.749 593.991 629.857 593.429C628.971 592.866 628.277 592.08 627.777 591.068C627.283 590.057 627.036 588.875 627.036 587.523C627.036 586.159 627.283 584.969 627.777 583.952C628.277 582.935 628.971 582.145 629.857 581.582C630.749 581.02 631.786 580.739 632.968 580.739C634.15 580.739 635.184 581.02 636.07 581.582C636.962 582.145 637.655 582.935 638.15 583.952C638.65 584.969 638.9 586.159 638.9 587.523C638.9 588.875 638.65 590.057 638.15 591.068C637.655 592.08 636.962 592.866 636.07 593.429C635.184 593.991 634.15 594.273 632.968 594.273ZM632.968 592.466C633.865 592.466 634.604 592.236 635.184 591.776C635.763 591.315 636.192 590.71 636.471 589.96C636.749 589.21 636.888 588.398 636.888 587.523C636.888 586.648 636.749 585.832 636.471 585.077C636.192 584.321 635.763 583.71 635.184 583.244C634.604 582.778 633.865 582.545 632.968 582.545C632.07 582.545 631.331 582.778 630.752 583.244C630.172 583.71 629.743 584.321 629.465 585.077C629.186 585.832 629.047 586.648 629.047 587.523C629.047 588.398 629.186 589.21 629.465 589.96C629.743 590.71 630.172 591.315 630.752 591.776C631.331 592.236 632.07 592.466 632.968 592.466ZM647.288 594.273C646.106 594.273 645.069 593.991 644.177 593.429C643.291 592.866 642.598 592.08 642.098 591.068C641.603 590.057 641.356 588.875 641.356 587.523C641.356 586.159 641.603 584.969 642.098 583.952C642.598 582.935 643.291 582.145 644.177 581.582C645.069 581.02 646.106 580.739 647.288 580.739C648.47 580.739 649.504 581.02 650.39 581.582C651.282 582.145 651.975 582.935 652.47 583.952C652.97 584.969 653.22 586.159 653.22 587.523C653.22 588.875 652.97 590.057 652.47 591.068C651.975 592.08 651.282 592.866 650.39 593.429C649.504 593.991 648.47 594.273 647.288 594.273ZM647.288 592.466C648.186 592.466 648.924 592.236 649.504 591.776C650.083 591.315 650.512 590.71 650.791 589.96C651.069 589.21 651.208 588.398 651.208 587.523C651.208 586.648 651.069 585.832 650.791 585.077C650.512 584.321 650.083 583.71 649.504 583.244C648.924 582.778 648.186 582.545 647.288 582.545C646.39 582.545 645.652 582.778 645.072 583.244C644.493 583.71 644.064 584.321 643.785 585.077C643.507 585.832 643.368 586.648 643.368 587.523C643.368 588.398 643.507 589.21 643.785 589.96C644.064 590.71 644.493 591.315 645.072 591.776C645.652 592.236 646.39 592.466 647.288 592.466ZM661.608 594.273C660.426 594.273 659.39 593.991 658.498 593.429C657.611 592.866 656.918 592.08 656.418 591.068C655.924 590.057 655.676 588.875 655.676 587.523C655.676 586.159 655.924 584.969 656.418 583.952C656.918 582.935 657.611 582.145 658.498 581.582C659.39 581.02 660.426 580.739 661.608 580.739C662.79 580.739 663.824 581.02 664.711 581.582C665.603 582.145 666.296 582.935 666.79 583.952C667.29 584.969 667.54 586.159 667.54 587.523C667.54 588.875 667.29 590.057 666.79 591.068C666.296 592.08 665.603 592.866 664.711 593.429C663.824 593.991 662.79 594.273 661.608 594.273ZM661.608 592.466C662.506 592.466 663.245 592.236 663.824 591.776C664.404 591.315 664.833 590.71 665.111 589.96C665.39 589.21 665.529 588.398 665.529 587.523C665.529 586.648 665.39 585.832 665.111 585.077C664.833 584.321 664.404 583.71 663.824 583.244C663.245 582.778 662.506 582.545 661.608 582.545C660.711 582.545 659.972 582.778 659.392 583.244C658.813 583.71 658.384 584.321 658.105 585.077C657.827 585.832 657.688 586.648 657.688 587.523C657.688 588.398 657.827 589.21 658.105 589.96C658.384 590.71 658.813 591.315 659.392 591.776C659.972 592.236 660.711 592.466 661.608 592.466Z" fill="white"/>
            </g>

            <g transform="translate(280, 440)" >
                <text x="325" y="50" fill='#fff' text-anchor="middle" alignment-baseline="middle" style="font-size: 46px;">Liquidity provider APY: ${APY}%</text>
            </g>

            <g transform="translate(280, 470)">
                <rect x="280" y="480" width="684" height="108" stroke="#ccc"/>
                <text x="340" y="50" fill='#fff' text-anchor="middle" alignment-baseline="middle" style="font-size: 13px;">
                    <tspan x="340">The APY estimation is for the first LP assuming the trading activity stays the same as it has been so far.</tspan>
                    <tspan x="340" dy="15">Later LPs earn from fewer trades, and the trading activity can change in the future, so the actual APY can be significantly different.</tspan>
                </text>
            </g>

            </svg>
        `;

                const b = await Buffer.from(svg);

                try {
                    image = await sharp(b)
                        .jpeg().toBuffer();
                } catch (e) {
                    console.error(e)
                }
            }
        } else if (['create', 'faq', 'main'].includes(type)) {
            image = await fs.readFile(`static/${type}.png`)
        }

        return reply
            .header('Content-Type', 'image/jpeg')
            .code(200)
            .send(image);
    } catch (e) {
        console.error('error', e)
    }
};


const strToArrayLines = (str, length) => {
    const firstStringArray = [];
    let fristStringLength = 0;

    str.split(" ").every((word) => {
        const newLength = fristStringLength + word.length + 1;

        if (newLength <= length) {
            firstStringArray.push(word);
            fristStringLength = newLength;
            return true;
        } else {
            return false;
        }
    })

    const firstLine = firstStringArray.join(" ")

    const secondLine = truncate(str.substring(fristStringLength, str.length), { length });

    return [
        firstLine,
        secondLine
    ]
}